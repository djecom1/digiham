#include "bch_31_21.h"

uint32_t bch_31_21_parity_check_matrix[] = {
    0b1001010010011110101011000000000,
    0b1101111011010001111110100000000,
    0b1111101111110110010100010000000,
    0b0111110111111011001010001000000,
    0b1010101001100011001110000100000,
    0b1100000110101111001100000010000,
    0b0110000011010111100110000001000,
    0b1010010011110101011000000000100,
    0b0101001001111010101100000000010,
    0b0010100100111101010110000000001
};

struct correction {
    uint16_t syndrome;
    uint32_t error_pattern;
};

// generated by applying possible combinations of errors
static struct correction corrections[] = {
    { 1, 1 },
    { 2, 2 },
    { 3, 3 },
    { 4, 4 },
    { 5, 5 },
    { 6, 6 },
    { 8, 8 },
    { 9, 9 },
    { 10, 10 },
    { 12, 12 },
    { 16, 16 },
    { 17, 17 },
    { 18, 18 },
    { 20, 20 },
    { 24, 24 },
    { 32, 32 },
    { 33, 33 },
    { 34, 34 },
    { 36, 36 },
    { 40, 40 },
    { 48, 48 },
    { 64, 64 },
    { 65, 65 },
    { 66, 66 },
    { 68, 68 },
    { 72, 72 },
    { 80, 80 },
    { 96, 96 },
    { 128, 128 },
    { 129, 129 },
    { 130, 130 },
    { 132, 132 },
    { 136, 136 },
    { 144, 144 },
    { 160, 160 },
    { 192, 192 },
    { 256, 256 },
    { 257, 257 },
    { 258, 258 },
    { 260, 260 },
    { 264, 264 },
    { 272, 272 },
    { 288, 288 },
    { 320, 320 },
    { 384, 384 },
    { 512, 512 },
    { 513, 513 },
    { 514, 514 },
    { 516, 516 },
    { 520, 520 },
    { 528, 528 },
    { 544, 544 },
    { 576, 576 },
    { 640, 640 },
    { 768, 768 },
    { 873, 1024 },
    { 872, 1025 },
    { 875, 1026 },
    { 877, 1028 },
    { 865, 1032 },
    { 889, 1040 },
    { 841, 1056 },
    { 809, 1088 },
    { 1001, 1152 },
    { 617, 1280 },
    { 361, 1536 },
    { 443, 2048 },
    { 442, 2049 },
    { 441, 2050 },
    { 447, 2052 },
    { 435, 2056 },
    { 427, 2064 },
    { 411, 2080 },
    { 507, 2112 },
    { 315, 2176 },
    { 187, 2304 },
    { 955, 2560 },
    { 722, 3072 },
    { 886, 4096 },
    { 887, 4097 },
    { 884, 4098 },
    { 882, 4100 },
    { 894, 4104 },
    { 870, 4112 },
    { 854, 4128 },
    { 822, 4160 },
    { 1014, 4224 },
    { 630, 4352 },
    { 374, 4608 },
    { 31, 5120 },
    { 717, 6144 },
    { 389, 8192 },
    { 388, 8193 },
    { 391, 8194 },
    { 385, 8196 },
    { 397, 8200 },
    { 405, 8208 },
    { 421, 8224 },
    { 453, 8256 },
    { 261, 8320 },
    { 133, 8448 },
    { 901, 8704 },
    { 748, 9216 },
    { 62, 10240 },
    { 755, 12288 },
    { 778, 16384 },
    { 779, 16385 },
    { 776, 16386 },
    { 782, 16388 },
    { 770, 16392 },
    { 794, 16400 },
    { 810, 16416 },
    { 842, 16448 },
    { 906, 16512 },
    { 522, 16640 },
    { 266, 16896 },
    { 99, 17408 },
    { 689, 18432 },
    { 124, 20480 },
    { 655, 24576 },
    { 381, 32768 },
    { 380, 32769 },
    { 383, 32770 },
    { 377, 32772 },
    { 373, 32776 },
    { 365, 32784 },
    { 349, 32800 },
    { 317, 32832 },
    { 509, 32896 },
    { 125, 33024 },
    { 893, 33280 },
    { 532, 33792 },
    { 198, 34816 },
    { 523, 36864 },
    { 248, 40960 },
    { 631, 49152 },
    { 762, 65536 },
    { 763, 65537 },
    { 760, 65538 },
    { 766, 65540 },
    { 754, 65544 },
    { 746, 65552 },
    { 730, 65568 },
    { 698, 65600 },
    { 634, 65664 },
    { 1018, 65792 },
    { 250, 66048 },
    { 403, 66560 },
    { 833, 67584 },
    { 396, 69632 },
    { 895, 73728 },
    { 496, 81920 },
    { 903, 98304 },
    { 669, 131072 },
    { 668, 131073 },
    { 671, 131074 },
    { 665, 131076 },
    { 661, 131080 },
    { 653, 131088 },
    { 701, 131104 },
    { 733, 131136 },
    { 541, 131200 },
    { 925, 131328 },
    { 157, 131584 },
    { 500, 132096 },
    { 806, 133120 },
    { 491, 135168 },
    { 792, 139264 },
    { 407, 147456 },
    { 992, 163840 },
    { 103, 196608 },
    { 595, 262144 },
    { 594, 262145 },
    { 593, 262146 },
    { 599, 262148 },
    { 603, 262152 },
    { 579, 262160 },
    { 627, 262176 },
    { 531, 262208 },
    { 723, 262272 },
    { 851, 262400 },
    { 83, 262656 },
    { 314, 263168 },
    { 1000, 264192 },
    { 293, 266240 },
    { 982, 270336 },
    { 345, 278528 },
    { 814, 294912 },
    { 169, 327680 },
    { 206, 393216 },
    { 975, 524288 },
    { 974, 524289 },
    { 973, 524290 },
    { 971, 524292 },
    { 967, 524296 },
    { 991, 524304 },
    { 1007, 524320 },
    { 911, 524352 },
    { 847, 524416 },
    { 719, 524544 },
    { 463, 524800 },
    { 166, 525312 },
    { 628, 526336 },
    { 185, 528384 },
    { 586, 532480 },
    { 197, 540672 },
    { 690, 557056 },
    { 309, 589824 },
    { 338, 655360 },
    { 412, 786432 }
};

uint16_t bch_31_21_parity(uint32_t* data) {
    /*
    int i;
    uint32_t poly = 0b11101101001;
    uint16_t parity = 0;
    for (int i = 0; i < (21 - 11); i++) {
        parity ^= *data & (poly >> i);
    }
    return parity;
    */
    uint16_t parity = 0;

    uint8_t k;
    for (k = 0; k < 10; k++) {
        uint8_t bit = 0, l;
        for (l = 0; l < 31; l++) {
            if ((bch_31_21_parity_check_matrix[k] >> l) & 1) {
                bit ^= ((*data >> l) & 1);
            }
        }

        parity = (parity << 1) | (bit & 1);
    }

    return parity;
}

bool bch_31_21(uint32_t* data) {
    uint16_t parity = bch_31_21_parity(data);

    if (parity == 0) return true;

    int num_corrections = sizeof(corrections)/sizeof(corrections[0]);
    for (int i = 0; i < num_corrections; i++) {
        if (corrections[i].syndrome == parity) {
            *data = *data ^ corrections[i].error_pattern;
            return true;
        }
    }

    return false;
}